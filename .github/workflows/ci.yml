name: CI - Test & Lint (UV)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.1.18'

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV
        uses: actions/cache@v3
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install black flake8 isort mypy

      - name: Run Black
        run: |
          source .venv/bin/activate
          black --check writer/ reader/

      - name: Run isort
        run: |
          source .venv/bin/activate
          isort --check-only writer/ reader/

      - name: Run Flake8
        run: |
          source .venv/bin/activate
          flake8 writer/ reader/ --max-line-length=100

      - name: Run MyPy
        run: |
          source .venv/bin/activate
          mypy writer/ reader/ --ignore-missing-imports
        continue-on-error: true

  test-writer:
    name: Test Writer Service
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV
        uses: actions/cache@v3
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-writer-${{ hashFiles('writer/uv.lock') }}

      - name: Install dependencies
        run: |
          cd writer
          uv venv
          source .venv/bin/activate
          uv sync --all-extras

      - name: Run tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          SHARED_VOLUME: /tmp/test_data
        run: |
          mkdir -p /tmp/test_data
          cd writer
          source .venv/bin/activate
          pytest ../tests/unit/test_writer.py -v --cov=. --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./writer/coverage.xml
          flags: writer

  test-reader:
    name: Test Reader Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV
        uses: actions/cache@v3
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-reader-${{ hashFiles('reader/uv.lock') }}

      - name: Install dependencies
        run: |
          cd reader
          uv venv
          source .venv/bin/activate
          uv sync --all-extras

      - name: Run tests
        env:
          SHARED_VOLUME: /tmp/test_data
        run: |
          mkdir -p /tmp/test_data
          cd reader
          source .venv/bin/activate
          pytest ../tests/unit/test_reader.py -v --cov=. --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./reader/coverage.xml
          flags: reader

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-writer, test-reader]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services
        run: |
          docker-compose up -d
          sleep 10

      - name: Wait for health
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:8001/health; do sleep 2; done'

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run integration tests
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install pytest requests
          pytest tests/integration/ -v

      - name: Show logs on failure
        if: failure()
        run: docker-compose logs

      - name: Cleanup
        if: always()
        run: docker-compose down -v